version: '2'
services:
  #unohouse.com.pl
  unohouse-app:
    build: ./vhosts/unohouse-com-pl
    container_name: app
    links:
      - unohousedb:unohousedb
    volumes:
      - /var/www:/var/www
    environment:
      - VIRTUAL_HOST=unohouse.dev
  # ===

  #docs.unohouse.com.pl
  docs-unohouse-com-pl:
    container_name: docs
    build: ./vhosts/docs-unohouse-com-pl
    volumes:
      - /var/www:/var/www
    environment:
      - VIRTUAL_HOST=docs.unohouse.dev
  # ===

  #yui Jenkins
  yui-unohouse-com-pl:
    build: ./vhosts/yui
    container_name: yui
    ports:
        - "50000:50000"
        - "8080:8080"
    volumes:
        - /var/jenkins_home
        - /var/www:/var/www
        - /var/run/docker.sock:/tmp/docker.sock:ro
    environment:
        JAVA_OPTS: "-Djava.awt.headless=true"
  # ===

  #yui.unohouse.com.pl
  yui-proxy-pass:
    build: ./vhosts/yui-proxy
    container_name: yui-proxy
    volumes:
        - /var/www:/var/www
    environment:
        - VIRTUAL_HOST=yui.unohouse.dev
  # ===

  # MySQL
  unohousedb:
    build: ./docker/unohousedb
    container_name: unohousedb
    ports:
      - "3306:3306"
    volumes:
      - /var/mysql:/var/lib/mysql
    environment:
      MYSQL_USER: root
      MYSQL_ROOT_PASSWORD: unohouse

  unomemcache:
    build: ./docker/unohousememcached
    container_name: memcache
    ports:
      - "11211:11211"

  # Proxy
  nginx-proxy:
      build: ./docker/nginx-proxy
      container_name: nginx-proxy
      ports:
        - "80:80"
        - "443:443"
      volumes_from:
        - unohouse-app
      volumes:
        - /var/run/docker.sock:/tmp/docker.sock:ro
        - ./logs/nginx/:/var/log/nginx

  #PMA
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    ports:
      - "8181:80"
    links:
      - unohousedb
    environment:
      - PMA_HOSTS=pma.dev
      - VIRTUAL_HOST=pma.dev
      - VIRTUAL_PORT=80
      - PMA_USER=root
      - PMA_PASSWORD=password
      - PMA_ABSOLUTE_URI=pma.dev

  elk:
    image: willdurand/elk
    ports:
        - 81:80
    volumes:
        - ./elk/logstash:/etc/logstash
        - ./elk/logstash/patterns:/opt/logstash/patterns
    volumes_from:
        - unohouse-app
        - nginx-proxy
